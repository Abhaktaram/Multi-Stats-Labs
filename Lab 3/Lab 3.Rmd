---
title: "Lab 3"
author: "Ananya Bhaktaram"
date: "`r Sys.Date()`"
output: html_document
---

### Question 1: 
Two models are defined below: Model 1: marginal linear model assuming an exchangeable correlation structure and Model 2: random intercept linear mixed effects model.  NOTE:  I have rescaled the time variable to represent years; {year}_{ij}={vistic}_{ij}/12.  This is out of convenience and to make the random intercept variance on a larger scale for ease of interpretation.  (Some might ask in frustration why we divided month by 24 before in lecture and by 12 now? Answer: so you understand that you can divide by any constant and get the same fitted model and to urge you to tailor the model to the problem at hand, making interpretation easier in different contexts.) 

Review the notation of each model and answer the questions below.

Model 1: Marginal linear assuming exchangeable correlation structure.
$$Y_{ij}=\beta_0+\beta_1{year}_{ij}+\beta_2I\left({trt}_i=1\right)\times{year}_{ij}+\beta_3I\left({trt}_i=2\right)\times{year}_{ij}+{\varepsilon_{ij}}$$
           
where ${\varepsilon^\ast}_{ij}~N\left(0,\sigma^2\right)$ and Corr$({\varepsilon^\ast}_{ij},\ {\varepsilon^\ast}_{ik})=\rho$ for all j not equal to k and Corr$({\varepsilon^\ast}_{ij},\ {\varepsilon^\ast}_{kl})=0$ for all i 	not equal to k and any j,l.

Model 2: Random intercept for child linear mixed model
$$Y_{ij}=\alpha_{0i}+\alpha_1{year}_{ij}+\alpha_2I\left({trt}_i=1\right)\times{year}_{ij}+\alpha_3I\left({trt}_i=2\right)\times{year}_{ij}+\varepsilon_{ij}$$
$$\alpha_{0i}=\alpha_0+a_i$$
where $\varepsilon_{ij}~N\left(0,{\sigma^2}_W\right)$ and Corr$(\varepsilon_{ij}, \ \varepsilon_{ik})=0$ for all j not equal to k, $a_i~N(0,{\sigma^2}_B)$ and Corr$(a_i,\ a_j)=0$ for all i not equal to j, and Corr$(a_i,\ \varepsilon_{jk})=0$ for all i,j,

a) In Model 1, ${\varepsilon^\ast}_{ij}$ is often referred to as the total residual.  Define this quantity in the context of the CAMP trial.

**The total residual represents the difference between the observed response and the fitted marginal mean. Model 1 assumes that there is an exchangeable correlation structure, which assumes that there is equal correlation between any two time points for the same subject. In the context of the CAMP study, we can interpret the total residual as the overall population mean difference of FEV1 output between treatment groups (budesonide, nedocromil) from the population mean of the placebo group at any given timepoint.**


b) In Model 2, $\varepsilon_{ij}$ is often referred to as the within-subject residual.  Define this quantity in the context of the CAMP trial.

**A total residual tells us how far from the population average are we, while a within-subject residual tells us how far an individual person is from the expected pattern given what we know about them. In the case of the CAMP study, the within-subject residual tells us how much higher or lower an individual child's FEV1 output was compared to the expected FEV1 output given their own individual baseline (modeled by the random intercept component). In this model the correlation is assumed to be 0, which means we assume that the random intercepts are drawn randomly from each other and therefore independent from one another, meaning that each child is assumed to have a unique baseline FEV1 value that is independent from other children's FEV1 values.**

c) In Model 2, $a_i$ is referred to as the random intercept for subject.  Define this quantity in the context of the CAMP trial.

**A random intercept accounts for unmeasured individual characteristics, by giving each individual a different starting point. In the context of the CAMP trial, the inclusion of a random intercept can be interpreted as each individual child's FEV1 output at baseline.**

### Question 2: 
Use the code provided below to fit Model 1 and 2 and answer the questions that follow:

```{r}
## Set working directory
setwd("C:/Users/anany/OneDrive/Hopkins/PhD/Year 3/Multilevel Stats I/Multi Stats Labs")

# Load relevant libraries
library(tidyverse)
library(here)
library(nlme)
library(mvtnorm)
library(ggplot2)


## Read in CAMP Dataset
camp_data <- read_csv("Lab 3/camp_primary.csv")
```

Run Model 1 and 2
```{r}
camp_data$year = camp_data$visitc/12

## Model 1: fit exponential model
fit1 <- gls(POSFEV ~ year + as.factor(trt):year, data=camp_data, na.action=na.omit,
                    correlation=corCompSymm(form=~1|id), method="ML")
summary(fit1)

## Model 2: random intercept for child model
fit2 <- lme(POSFEV ~ year + as.factor(trt):year, data=camp_data,
                      random=~1|id, method="ML",na.action=na.omit)
summary(fit2)

```
a) From Model 1 and 2, $Var\left(Y_{ij}\right)=\sigma^2={\sigma^2}_W+{\sigma^2}_B$.  Use the model results to confirm this.

$\sigma = 0.6371549$

$\rho = 0.9051032$

$\sigma^2 = 0.405966$

rho is  the correlation parameter which is calculated as the proportion between variance components $\rho=\frac{{\sigma^2}_B}{{\sigma^2}_W+{\sigma^2}_B}$

$\sigma^2}_W = \sigma^2 * (1 - \rho)$ which is equivalent to $\sigma^2}_W = 0.405966 * (1 - 0.9051032) = 0.0385$

$\sigma^2_B = \sigma^2 * \rho$ which is equivalent to $\sigma^2_B = 0.0405966 * 0.9051032 = 0.3675$

and 0.406 = 0.0385 + 0.3675 which means that the model results confirm the equation's solution.



b) In Model 2, $Corr(Y_{ij},\ Y_{ik})=\frac{{\sigma^2}_B}{{\sigma^2}_W+{\sigma^2}_B}$.  Use the results of Model 2 to compute this correlation and compare it the value of $\rho$ obtained from Model 1.

$\sigma^2_B$ represents the between-subject variance which is also the random intercept squared, while $\sigma^2_W$ is the within-subject variance which is represented by the random intercept residual squared.

$\sigma^2_B = (0.606151695)^2 = 0.3674$ 

$\sigma^2_W = (0.1962776)^2 = 0.0385)$

$Corr(Y_{ij},\ Y_{ik})= 0.3674/(0.3674+ 0.0385)$

$Corr(Y_{ij},\ Y_{ik})= 0.905$

**The calculated $Corr(Y_{ij},\ Y_{ik})$ value is almost identical to the $\rho$ value in model 1, which tells us that there is very high-within subject correlation for both models and that the correlation between any two observations from the same subject is about 0.905. This means that the addition of random intercepts into model 2 didn't actually change the correlation associations from model 1.**

c) Compare the estimates of the population intercept and slopes for Model 1 and 2.  Do you expect that these should be the same or different?

**The population intercept for Model 1 is 1.8157524 and the slope for treatment group 1 is 0.231 and the slope for treatment group 2 is 0.226**

**The population intercept for Model 2 is 1.8157524 and the slope for treatment group 1 is 0.231 and the slope for treatment group 2 is 0.226.**

**We would expect and find that the intercept and the slope intercepts are nearly identical because both models are fitting the same marginal mean structure with very similar correlation assumptions. We see small differences in standard errors due to the different computational approaches used between Model 1 and Model 2**

d) Using the results of Model 2, provide an interval that includes roughly 95% of children’s expected FEV1 values at 

**The standard error for the intercept is 0.02334234**

**Therefore the lower bound for the 95% CI = 1.8157524 - (1.96 * 0.023342343) = 1.770**

**The upper bound for the 95% CI = 1.8157524 + (1.96 * 0.023342343) = 1.861)**

**The 95% confidence interval of the children's expected FEV1 is 1.861 units 95%CI:(1.770, 1.861)**

### Question 3: 
The model below expands Model 2 to allow for a random intercept for each child and random slope for time for each child.  Refer to this model as Model 3.

$$Y_{ij}=\alpha_{0i}+\alpha_{1i}{year}_{ij}+\alpha_2I\left({trt}_i=1\right)\times{year}_{ij}+\alpha_3I\left({trt}_i=2\right)\times{year}_{ij}+\varepsilon_{ij}$$
$$\alpha_{0i}=\alpha_0+a_{0i}$$
$$\alpha_{1i}=\alpha_1+a_{1i}$$

where $\varepsilon_{ij}~N\left(0,{\sigma^2}_W\right)$ and $Corr(\varepsilon_{ij},\ \varepsilon_{ik})=0$ for all j not equal to k, $a_{0i}~N(0,{\sigma^2}_{0B}),\ a_{1i}~N(0,{\sigma^2}_{1B})$,  and $Corr(a_{0i},\ a_{1i})=\sigma_{01}$.  In addition, the children i are independent and the within subject residuals $(\varepsilon_{ij})$ are independent of the child specific effects $(a_{0i},a_{1i})$

Review this model and answer the following:

a) Define the population mean yearly change in FEV1 among children receiving budesonide.

**The expected population mean yearly change in FEV1 among children receiving budesonide = $\alpha_1 + \alpha_3$, assuming that budesonide is treatment group 2 as $\alpha_$ is the population-level fixed effect for the baseline yearly change, and $\alpha_3$ is the population-level difference for the additional change due to budesonide**


b) Define a child’s mean yearly change in FEV1 if the child received budesonide.

**A specific child who is receiving budesonide's mean yearly change (assuming that budesonide is treatment group 2) in FEV1 would be $\alpha_1i + \alpha_3 = (\alpha_1 + \alpha_1i) + \alpha_3$. $\alpha+1i = \alpha_1 + \alpha_1i$ represents the child's expected average yearly change at baseline, while $\alpha_3$ represents the additional change to their average yearly trajectory that is attributed to being in the budesonide treatment group. As a result the individual child's mean yearly change in FEV1 with budesonide is $\alpha_1 + \alpha_1i + \alpha_3.**


c) Interpret $a_{1i}$ within the context of the CAMP trial.

**$\alpha_1i$ tells us how much child i's FEV1 changes per year when they are in the placebo group. This tells us a specific child's deviation from the population mean FEV1 at a given time point. This also represents child i's personal baseline slope.**


d) Suppose $\sigma_{01}$ is positive (i.e. > 0).  Interpret what this means in the context of the CAMP trial.

**A positive $\sigma_{01}$ value tells us that if an individual had a higher than average FEV1 output at time zero, then they were more likely to have a higher than average increase in FEV1 over the duration of 1 year. In sum, it tells us that the FEV1 intial output co-occurs with future FEV1 measurement.**

### Question 4: 
Fit the model proposed above and answer the following questions.

```{r}
## Model 3: random intercept and random slope for time
fit3 = lme(POSFEV ~ year+as.factor(trt):year,data=camp_data,na.action=na.omit,  
   random = ~ 1 + year | id,method="ML")
summary(fit3)

```

a) Provide an interval that contains roughly 95% of children’s expected FEV1 values at baseline.

$\alpha_0 \pm 1.96 \times \sqrt{SE(\alpha_0)^2 + \sigma_{0b}^2}$

Lower bound = $1.8160690 -1.96 * \sqrt{(0.019233814)^2 +(0.5017182)^2}$
            = $1.816 - 1.96 * \sqrt{0.0003699 + 0.2517}$
            = $1.816 - 1.96 * 0.5017$ ## Doesn't this just come out to be the same as the standard deviation of the intercept? 
            = 1.816 - 0.9833
            = 0.8327 
            
Upper bound = 1.816 + 0.9833
            = 2.7993
            
**95% of all children's expected FEV1 values at baseline fall within the range of 0.833-2.799 with the point estimate or mean being 1.816.**


b) Provide an interval that contains roughly 95% of the expected yearly change in FEV1 among children receiving the placebo.

$\alpha_1 \pm 1.96 \times \sqrt{SE(\alpha_1)^2 + \sigma^2_1B}$

$0.2471685 \pm 1.96 \times 0.1034$

$0.247 \pm 0.203$

**The expected yearly change in FEV1 among children receiving the placebo is 0.247 with 95% CI:(0.044, 0.45).**


c) Provide intervals that contains roughly 95% of the expected yearly change in FEV1 among children receiving budesonide and nedocromil, respectively


BUDESONIDE: $\alpha_1 + \alpha_2$
            
            = 0.2471685 + (-0.0210513) = 0.2261172

for the 95% CI $Cov(\alpha_1,\alpha_2) = Corr(\alpha_1, \alpha_2) * SE(\alpha_2)$
            
            = -0.629 * 0.006185225 * 0.008955171 = -3.48 * 10^-5
            
The estimated 95% CI for FEV1 among children receiving budesonide (assuming that it is treatment group 1) is (0.2124, 0.2398) with the point estimate being 0.226

NEDOCROMIL: $\alpha_1 + \alpha_3$
            
            = 0.2471685 + 0.0025269 = 0.2496954

for the 95% CI $Cov(\alpha_1,\alpha_3) = Corr(\alpha_1, \alpha_3) * SE(\alpha_3)$

            = `r -0.629 * 0.006185225 * 0.008966122`

The estimated 95% CI for FEV1 among children receiving nedocromil (assuming that it is treatment group 2) is (0.236, 0.263) with a point estimate of 0.250.

### Question 5: 
Compare the fit of Model 3 to the models you considered in Homework 1.  Namely, fit the following parametric correlation models:
  1.	Independence
  2.	Exchangeable (or random intercept model)
  3.	Exponential 
  4.	Random intercept + Exponential correlation structure
  5.	Random intercept + random slope for time
```{r}
# Fit the independence model
mA = gls(POSFEV~year+as.factor(trt):year,data=camp_data,na.action=na.omit,method="ML")

# Fit the exchangeable model
mB = gls(POSFEV~year+as.factor(trt):year,data=camp_data,na.action=na.omit,correlation=corCompSymm(form=~1|id),method="ML")

# Fit the exponential model
mC = gls(POSFEV~year+as.factor(trt):year,data=camp_data,na.action=na.omit,correlation=corExp(form=~year|id),method="ML")

# Fit the random intercept + exponential within subject correlation structure
mD = lme(POSFEV~year+as.factor(trt):year,data=camp_data,na.action=na.omit,  
   random = ~ 1 | id, correlation = corExp(form=~year|id),method="ML")

# Fit the random intercept + slope model
mE = lme(POSFEV~year+as.factor(trt):year,data=camp_data,na.action=na.omit,  
   random = ~ 1 + year | id,method="ML")

c(AIC(mA),AIC(mB),AIC(mC),AIC(mD),AIC(mE))

```

Based on the AIC statistics, which of these models is most consistent with the data?

**Based off of the AIC values, the final model (random intercept with random slope) is the most consistent with the data as it has the lowest AIC score. Given how poorly the independence model performed we can interpret that our data does have strongly correlated FEV1 values. All models that included a random intercept performed better than those that did not, finally the inclusion of a random slope which allows for each individual to have their own rate of change fit the data the best. This suggests that children have different FEV1 levels at baseline (modeled by the random intercept) and they have different rates of FEV1 change over time (modeled by the random slope).**

### Question 6: 

Use the formula below to compute the estimate of $Var\left(Y_{ij}\right)$ at 2, 12, and 48 months using the fit of Model 3.  Compare these values to those obtained from the exploratory analysis conducted in Homework 1 (see Table 1).

$$Var\left(Y_{ij}\right)={\sigma^2}_{0B}+{{year}^2}_{ij}\times{\sigma^2}_{1B}+2\times{year}_{ij}\times\sigma_{01}+{\sigma^2}_W$$
$\sigma^2_0B$ = the variance of the random intercept squared (0.5017182)^2 = 0.02517

$\sigma^2_1b$ = the variance of the random slope squared = (0.10248405)^2 = 0.0106

$\sigma_01$ = the covariance between the random intercept and the slope ($Corr(\sigma_0B * \sigma_1B)$)
            = 0.516 * o.5017182 * 0.1028405 = 0.0266

$\sigma^2_W$ = the residual variance squared = (0.1345861)^2 = 0.0181


$Var(Y_ij) = 

Calculated Table 1: 
```{r}
sigma2_0B <- 0.2517 # Variance from random intercept
sigma2_1B <- 0.0106 # Variance from random slope
sigma_01 <- 0.0266 # Estimated covariance between intercept and slope
sigma2_W <- 0.0181  # Residual Variance

# create time points for estimation
months <- c(2,12,48)

# Calculate variance at each time point
variance <- sigma2_0B + months^2 * sigma2_1B + 2 * months * sigma_01 + sigma2_W

# Create variance table
variance_table <- data.frame(
  "Time (months)" = months,
  "Estimated Variance" = round(variance, 4),
  "Standard Deviation" = round(sqrt(variance), 4)
)

# Display table for comparison to provided variance table
knitr::kable(variance_table, 
             caption = "Estimated Variance of FEV1 at Different Time Points")
```


Provided Table 1
```{r}
knitr::include_graphics("C:/Users/anany/OneDrive/Hopkins/PhD/Year 3/Multilevel Stats I/Multi Stats Labs/Lab 3/Provided Table 1.png")
```

**The variance estimates shown in the provided exploratory data analysis table are dramatically lower than the calculated ones using the outputs from model 3. This is because ANOVA only estimates between-subject variance at each time point, which is relatively low, whereas the mixed-effects model (model 3) estimates the total variance which includes between-subject, within subject and correlation effects. This accounts for how individual children's FEV outputs diverge over time, the random slope variance $\sigma^2_1B$ gets multiplied by year^2 in the provided equation, causing exponential growth, which is why the variance increases dramatically overtime. This tells us that at baseline, children's FEV1 measurements are relatively similar, but over time as children grow, their individual trajectories increase the spread in FEV1 values. The random slope component dictates a larger portion of variance at later lags. This pattern is fairly common in longitudinal studies when you anticipate that there will be substantial individual change over time.**

```{r}
# R Session Information
options(width = 120)
sessioninfo::session_info()
```

